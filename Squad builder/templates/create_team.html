{% extends "layout.html" %}

{% block title %}
    Create {{ team_type|capitalize }} Team
{% endblock %}

{% block main %}
<style>
    #pitch {
        background-image: url('{{ background }}');
        background-size: cover;
        background-position: center;
        width: 100%;
        height: 800px; /* Adjust height as needed */
        position: relative;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .player-slot {
        position: absolute;
        width: 80px;
        height: 100px;
        text-align: center;
        cursor: pointer;
    }
    .player-slot.active-slot {
        transform: scale(1.1);
        border: 2px dashed #0d6efd;
        border-radius: 50%;
    }
    .player-token {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        background-color: #343a40;
    }
    .player-name {
        color: white;
        font-size: 12px;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.6);
        border-radius: 4px;
        padding: 2px 4px;
        margin-top: 2px;
        white-space: nowrap;
    }
    .remove-player {
        position: absolute;
        top: -5px;
        right: 5px;
        color: red;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        line-height: 18px;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid red;
    }
    #player-list {
        max-height: 500px;
        overflow-y: auto;
    }
    .player-card.disabled {
        opacity: 0.5;
        pointer-events: none;
    }
</style>

<div class="container-fluid">
    <h2 class="mb-4">Create Your {{ team_type|capitalize }} Team</h2>
    <form id="create-team-form" action="/create_team" method="POST">
        <input type="hidden" name="team_type" value="{{ team_type }}">
        <input type="hidden" id="player_ids" name="player_ids">

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="team_name" class="form-label">Team Name</label>
                <input type="text" class="form-control" id="team_name" name="team_name" placeholder="Enter your team's name" required>
            </div>
            <div class="col-md-6">
                <label for="formation" class="form-label">Select Formation</label>
                <select class="form-select" id="formation" name="formation">
                    <option value="4-4-2">4-4-2</option>
                    <option value="4-3-3">4-3-3</option>
                    <option value="3-4-3">3-4-3</option>
                    <option value="5-3-2">5-3-2</option>
                    <option value="4-2-3-1">4-2-3-1</option>
                    <option value="4-2-4">4-2-4</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div id="pitch">
                    </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        {% if team_type == 'fantasy' %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Budget</h5>
                            <h5 class="mb-0" id="budget-display">$700 M</h5>
                        </div>
                        <hr>
                        {% endif %}

                        <h5 class="mb-3">Available Players</h5>
                        <input type="text" id="search-bar" class="form-control mb-3" placeholder="Search players...">

                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-secondary position-filter active" data-position="All">All</button>
                            <button type="button" class="btn btn-outline-secondary position-filter" data-position="Goalkeeper">GK</button>
                            <button type="button" class="btn btn-outline-secondary position-filter" data-position="Defender">DEF</button>
                            <button type="button" class="btn btn-outline-secondary position-filter" data-position="Midfielder">MID</button>
                            <button type="button" class="btn btn-outline-secondary position-filter" data-position="Forward">FWD</button>
                        </div>

                        <div id="player-list" class="list-group">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg">Save Team</button>
        </div>
    </form>
</div>

<script>
// Use Jinja's 'tojson' filter to safely pass the player data from Flask to JavaScript
const ALL_PLAYERS = {{ players|tojson }};
const TEAM_TYPE = '{{ team_type }}';
const INITIAL_BUDGET = 700;

// Application state
let currentFormation = '4-4-2';
let selectedPlayers = new Array(11).fill(null); // Corresponds to 11 slots
let remainingBudget = INITIAL_BUDGET;
let activeSlotIndex = -1; // Which slot on the pitch is currently selected

// Formation coordinates (top%, left%)
const FORMATIONS = {
    '4-4-2': [
        { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
        { top: '70%', left: '15%', pos: 'Defender' }, { top: '70%', left: '35%', pos: 'Defender' }, { top: '70%', left: '65%', pos: 'Defender' }, { top: '70%', left: '85%', pos: 'Defender' }, // DEF
        { top: '45%', left: '15%', pos: 'Midfielder' }, { top: '45%', left: '35%', pos: 'Midfielder' }, { top: '45%', left: '65%', pos: 'Midfielder' }, { top: '45%', left: '85%', pos: 'Midfielder' }, // MID
        { top: '20%', left: '35%', pos: 'Forward' }, { top: '20%', left: '65%', pos: 'Forward' } // FWD
    ],
    '4-3-3': [
        { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
        { top: '70%', left: '15%', pos: 'Defender' }, { top: '70%', left: '35%', pos: 'Defender' }, { top: '70%', left: '65%', pos: 'Defender' }, { top: '70%', left: '85%', pos: 'Defender' }, // DEF
        { top: '50%', left: '25%', pos: 'Midfielder' }, { top: '50%', left: '50%', pos: 'Midfielder' }, { top: '50%', left: '75%', pos: 'Midfielder' }, // MID
        { top: '20%', left: '20%', pos: 'Forward' }, { top: '15%', left: '50%', pos: 'Forward' }, { top: '20%', left: '80%', pos: 'Forward' } // FWD
    ],
    '3-4-3': [
        { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
        { top: '70%', left: '25%', pos: 'Defender' }, { top: '70%', left: '50%', pos: 'Defender' }, { top: '70%', left: '75%', pos: 'Defender' }, // DEF
        { top: '45%', left: '15%', pos: 'Midfielder' }, { top: '45%', left: '35%', pos: 'Midfielder' }, { top: '45%', left: '65%', pos: 'Midfielder' }, { top: '45%', left: '85%', pos: 'Midfielder' }, // MID
        { top: '20%', left: '20%', pos: 'Forward' }, { top: '15%', left: '50%', pos: 'Forward' }, { top: '20%', left: '80%', pos: 'Forward' } // FWD
    ],
    '5-3-2': [
        { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
        { top: '70%', left: '10%', pos: 'Defender' }, { top: '70%', left: '30%', pos: 'Defender' }, { top: '70%', left: '50%', pos: 'Defender' }, { top: '70%', left: '70%', pos: 'Defender' }, { top: '70%', left: '90%', pos: 'Defender' }, // DEF
        { top: '45%', left: '25%', pos: 'Midfielder' }, { top: '45%', left: '50%', pos: 'Midfielder' }, { top: '45%', left: '75%', pos: 'Midfielder' }, // MID
        { top: '20%', left: '35%', pos: 'Forward' }, { top: '20%', left: '65%', pos: 'Forward' } // FWD
    ],
    '4-2-3-1': [
        { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
        { top: '75%', left: '15%', pos: 'Defender' }, { top: '75%', left: '35%', pos: 'Defender' }, { top: '75%', left: '65%', pos: 'Defender' }, { top: '75%', left: '85%', pos: 'Defender' }, // DEF
        { top: '55%', left: '35%', pos: 'Midfielder' }, { top: '55%', left: '65%', pos: 'Midfielder' }, // Defensive Mids
        { top: '35%', left: '20%', pos: 'Midfielder' }, { top: '35%', left: '50%', pos: 'Midfielder' }, { top: '35%', left: '80%', pos: 'Midfielder' }, // Attacking Mids
        { top: '15%', left: '50%', pos: 'Forward' } // FWD
    ],
    '4-2-4': [
    { top: '88%', left: '50%', pos: 'Goalkeeper' }, // GK
    { top: '70%', left: '15%', pos: 'Defender' }, { top: '70%', left: '35%', pos: 'Defender' }, { top: '70%', left: '65%', pos: 'Defender' }, { top: '70%', left: '85%', pos: 'Defender' }, // DEF
    { top: '50%', left: '35%', pos: 'Midfielder' }, { top: '50%', left: '65%', pos: 'Midfielder' }, // MID
    { top: '20%', left: '15%', pos: 'Forward' }, { top: '20%', left: '35%', pos: 'Forward' }, { top: '20%', left: '65%', pos: 'Forward' }, { top: '20%', left: '85%', pos: 'Forward' } // FWD
    ]
};

document.addEventListener('DOMContentLoaded', () => {
    // Event listeners
    document.getElementById('formation').addEventListener('change', handleFormationChange);
    document.getElementById('search-bar').addEventListener('keyup', renderPlayerList);
    document.querySelectorAll('.position-filter').forEach(btn => btn.addEventListener('click', handlePositionFilter));
    document.getElementById('create-team-form').addEventListener('submit', handleFormSubmit);

    // Initial setup
    drawPitch();
    renderPlayerList();
    updateBudgetDisplay();
});

function drawPitch() {
    const pitch = document.getElementById('pitch');
    pitch.innerHTML = ''; // Clear existing slots
    const slots = FORMATIONS[currentFormation];

    slots.forEach((slot, index) => {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'player-slot';
        slotDiv.style.top = slot.top;
        slotDiv.style.left = slot.left.endsWith('%') ? `calc(${slot.left} - 40px)` : slot.left;
        slotDiv.dataset.index = index;
        slotDiv.dataset.position = slot.pos;

        const player = selectedPlayers[index];
        if (player) {
            // If a player is in this slot, render their token
            slotDiv.innerHTML = `
                <div class="remove-player" onclick="removePlayer(event, ${index})">&times;</div>
                <img src="${player.image_url}" class="player-token">
                <div class="player-name">${player.name}</div>
            `;
        } else {
            // Otherwise, render an empty slot placeholder
            slotDiv.innerHTML = `
                <img src="/static/images/shirt_placeholder.svg" class="player-token" style="opacity:0.5;">
                <div class="player-name" style="background: #6c757d;">${slot.pos}</div>
            `;
        }

        slotDiv.addEventListener('click', () => handleSlotClick(index));
        pitch.appendChild(slotDiv);
    });
}


function renderPlayerList() {
    const list = document.getElementById('player-list');
    list.innerHTML = '';

    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const activePositionFilter = document.querySelector('.position-filter.active').dataset.position;

    const filteredPlayers = ALL_PLAYERS.filter(p => {
        const nameMatch = p.name.toLowerCase().includes(searchTerm);
        const positionMatch = activePositionFilter === 'All' || p.position === activePositionFilter;
        return nameMatch && positionMatch;
    });

    filteredPlayers.forEach(player => {
        const isSelected = selectedPlayers.some(p => p && p.id === player.id);
        const card = document.createElement('div');
        card.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center player-card ${isSelected ? 'disabled' : ''}`;

        let costHtml = TEAM_TYPE === 'fantasy' ? `<span class="fw-bold">$${player.cost}M</span>` : '';
        card.innerHTML = `
            <div>
                <img src="${player.image_url}" class="rounded-circle me-2" width="40" height="40">
                <strong>${player.name}</strong> <small class="text-muted">(${player.position})</small>
            </div>
            <div>
                ${costHtml}
                <button class="btn btn-sm btn-primary ms-3" onclick="addPlayer(${player.id})">Add</button>
            </div>
        `;
        list.appendChild(card);
    });
}

function handleSlotClick(index) {
    // Set the clicked slot as active and filter player list
    activeSlotIndex = index;
    const allSlots = document.querySelectorAll('.player-slot');
    allSlots.forEach(s => s.classList.remove('active-slot'));
    allSlots[index].classList.add('active-slot');

    const requiredPosition = allSlots[index].dataset.position;
    // Automatically switch the position filter on the right
    const filterButtons = document.querySelectorAll('.position-filter');
    filterButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.position === requiredPosition);
    });
    renderPlayerList();
}


function handleFormationChange(event) {
    currentFormation = event.target.value;
    // Reset team when formation changes to avoid invalid positions
    selectedPlayers.fill(null);
    remainingBudget = INITIAL_BUDGET;
    activeSlotIndex = -1;
    drawPitch();
    renderPlayerList();
    updateBudgetDisplay();
}

function handlePositionFilter(event) {
    document.querySelectorAll('.position-filter').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderPlayerList();
}
function addPlayer(playerId) {
    if (activeSlotIndex === -1) {
        alert("Please select a slot on the pitch first!");
        return;
    }

    const newPlayer = ALL_PLAYERS.find(p => p.id === playerId);
    const slotPosition = document.querySelector(`.player-slot[data-index='${activeSlotIndex}']`).dataset.position;
    const existingPlayer = selectedPlayers[activeSlotIndex];

    // Validation
    if (newPlayer.position !== slotPosition) {
        alert(`Invalid position! This slot requires a ${slotPosition}.`);
        return;
    }
    
    if (TEAM_TYPE === 'fantasy') {
        // Temporarily calculate the budget available for this slot
        let potentialBudget = remainingBudget;
        if (existingPlayer) {
            potentialBudget += existingPlayer.cost; // Add back the cost of the player being replaced
        }

        if (newPlayer.cost > potentialBudget) {
            alert("Not enough budget!");
            return;
        }

        // If validation passes, commit the budget change
        remainingBudget = potentialBudget - newPlayer.cost;
    }

    // Place the new player in the slot
    selectedPlayers[activeSlotIndex] = newPlayer;

    // Reset active slot and redraw everything
    activeSlotIndex = -1;
    drawPitch();
    renderPlayerList();
    updateBudgetDisplay();
}

function removePlayer(event, index) {
    event.stopPropagation(); // Prevent the slot click from firing
    const removedPlayer = selectedPlayers[index];
    if (TEAM_TYPE === 'fantasy') {
        remainingBudget += removedPlayer.cost;
    }
    selectedPlayers[index] = null;

    drawPitch();
    renderPlayerList();
    updateBudgetDisplay();
}

function updateBudgetDisplay() {
    if (TEAM_TYPE === 'fantasy') {
        document.getElementById('budget-display').textContent = `$${remainingBudget} M`;
    }
}

function handleFormSubmit(event) {
    event.preventDefault(); // Stop the form from submitting normally
    const filledSlots = selectedPlayers.filter(p => p !== null);
    if (filledSlots.length < 11) {
        alert("Your team is not complete! Please select 11 players.");
        return;
    }

    const teamName = document.getElementById('team_name').value;
    if (!teamName) {
        alert("Please enter a name for your team.");
        return;
    }

    // Populate the hidden input with a comma-separated list of player IDs
    document.getElementById('player_ids').value = selectedPlayers.map(p => p.id).join(',');

    // Now, submit the form for real
    event.target.submit();
}

</script>
{% endblock %}
