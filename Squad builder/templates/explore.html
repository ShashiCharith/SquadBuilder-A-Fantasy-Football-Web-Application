{% extends "layout.html" %}

{% block title %}
    Explore Teams
{% endblock %}

{% block main %}
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="display-5">Explore Community Squads</h2>
            <p class="lead text-muted">Discover, view, and rate teams built by other users.</p>
        </div>

        <!-- Search Bar - No longer a form, uses an ID for JavaScript -->
        <div class="mb-4">
            <input class="form-control" type="search" placeholder="Search by Creator's Username..." id="team-search-bar">
        </div>

        <!-- This div will be populated by the JavaScript below -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="team-grid">
            <!-- Team cards will be inserted here dynamically -->
        </div>
    </div>

<script>
    // Safely pass the full list of teams from Flask to this JavaScript variable
    const ALL_TEAMS = {{ all_teams|tojson }};

    document.addEventListener('DOMContentLoaded', () => {
        const searchBar = document.getElementById('team-search-bar');
        const teamGrid = document.getElementById('team-grid');

        // This function redraws the team cards based on the search input
        function renderTeams() {
            const searchTerm = searchBar.value.toLowerCase();
            let html = '';

            // Filter the full list of teams in the browser
            const filteredTeams = ALL_TEAMS.filter(team =>
                team.username.toLowerCase().includes(searchTerm)
            );

            if (filteredTeams.length > 0) {
                filteredTeams.forEach(team => {
                    // Safely handle potentially null average rating
                    const rating = team.avg_rating ? team.avg_rating.toFixed(1) : 'Not Rated';

                    const teamTypeBadge = team.team_type === 'fantasy'
                        ? `<span class="badge bg-primary">Fantasy Team</span>`
                        : `<span class="badge bg-success">Dream Team</span>`;

                    // Build the HTML for one team card
                    html += `
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">${team.team_name}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">Created by: ${team.username}</h6>
                                    <p class="card-text mt-3">${teamTypeBadge}</p>
                                    <p class="card-text fs-4">
                                        <strong>Rating:</strong> ‚≠ê ${rating}
                                    </p>
                                    <a href="/team/${team.id}" class="btn btn-dark">View Squad</a>
                                </div>
                                <div class="card-footer text-muted">
                                    Created on ${team.created_at_formatted}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                // Show a message if no teams match the search
                html = `
                    <div class="col-12">
                        <div class="alert alert-info text-center" role="alert">
                            No teams found matching your search.
                        </div>
                    </div>
                `;
            }
            // Update the grid with the new HTML
            teamGrid.innerHTML = html;
        }

        // Listen for typing in the search bar
        searchBar.addEventListener('keyup', renderTeams);

        // Show all teams when the page first loads
        renderTeams();
    });
</script>
{% endblock %}

